import os
import asyncio
from pyrogram import Client, filters
from pyrogram.types import Message
from flask import Flask, jsonify
from threading import Thread

# --- 1. рдЕрдкрдиреА рдЬрд╛рдирдХрд╛рд░реА рдпрд╣рд╛рдВ рднрд░реЗрдВ (Your Info Here) ---
# NOTE: рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдЗрдиреНрд╣реЗрдВ .env рдлрд╛рдЗрд▓ рдореЗрдВ рд░рдЦрдирд╛ рдЪрд╛рд╣рд┐рдПред
# рд╕рд╛рджрдЧреА рдХреЗ рд▓рд┐рдП, рдореИрдВ рдЗрдиреНрд╣реЗрдВ рд╕реАрдзреЗ рдпрд╣рд╛рдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░ рд░рд╣рд╛ рд╣реВрдБред
API_ID = 16267139
API_HASH = "e0bdab938a5b5d771411f45ee12a9f2b"
BOT_TOKEN = "8347361707:AAHGPqpYoSqfKeex_QSvb6Wgg-BjeXD7Q10"
ADMIN_ID = 7843231115  # рдЖрдкрдХрд╛ Telegram Admin ID
CHANNEL_ID = -1002714387561 # рдЖрдкрдХрд╛ Private Channel ID (рд╕реНрдЯреЛрд░реЗрдЬ рдХреЗ рд▓рд┐рдП)
BOT_USERNAME = "adultvideofree_bot" # рдЖрдкрдХреЗ рдмреЙрдЯ рдХрд╛ рдпреВрдЬрд░рдиреЗрдо

# --- 2. Pyrogram рдХреНрд▓рд╛рдЗрдВрдЯ рд╢реБрд░реВ рдХрд░реЗрдВ (Initialize Pyrogram Client) ---
# 'LinkBot' session name рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ
app = Client(
    "LinkBot",
    api_id=API_ID,
    api_hash=API_HASH,
    bot_token=BOT_TOKEN
)

# --- 3. рдПрдбрдорд┐рди рджреНрд╡рд╛рд░рд╛ рдлрд╛рдЗрд▓ рдЕрдкрд▓реЛрдб рд╣реИрдВрдбрд▓рд░ (Admin File Upload Handler) ---
@app.on_message(filters.private & filters.user(ADMIN_ID) & (filters.document | filters.video | filters.audio | filters.photo))
async def handle_admin_file(client: Client, message: Message):
    """
    рдЬрдм рдПрдбрдорд┐рди рдХреЛрдИ рдлрд╝рд╛рдЗрд▓ (рдбреЙрдХреНрдпреВрдореЗрдВрдЯ, рд╡реАрдбрд┐рдпреЛ, рдСрдбрд┐рдпреЛ, рдлреЛрдЯреЛ) рднреЗрдЬрддрд╛ рд╣реИ,
    рддреЛ рдЙрд╕реЗ рдЪреИрдирд▓ рдореЗрдВ рдХреЙрдкреА рдХрд░рддрд╛ рд╣реИ рдФрд░ deep link рдмрдирд╛рддрд╛ рд╣реИред
    """
    try:
        # рдлрд╝рд╛рдЗрд▓ рдХреЛ рдЪреИрдирд▓ рдореЗрдВ рдХреЙрдкреА рдХрд░реЗрдВред рдЗрд╕рд╕реЗ original message_id channel рдореЗрдВ рдорд┐рд▓реЗрдЧрд╛ред
        await message.reply_text("рдлрд╝рд╛рдЗрд▓ рдЪреИрдирд▓ рдореЗрдВ рд╕реНрдЯреЛрд░ рд╣реЛ рд░рд╣реА рд╣реИ... рдХреГрдкрдпрд╛ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВред")
        
        # message.copy() рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдлрд╝рд╛рдЗрд▓ Channel рдореЗрдВ store рд╣реЛ рдЬрд╛рдП
        forwarded_msg = await message.copy(CHANNEL_ID)
        
        # Deep Link рдмрдирд╛рдПрдВ: format рд╣реИ t.me/<bot_username>?start=<message_id>
        message_id = forwarded_msg.id
        deep_link = f"https://t.me/{BOT_USERNAME}?start={message_id}"
        
        # рдПрдбрдорд┐рди рдХреЛ deep link рднреЗрдЬреЗрдВ
        await message.reply_text(
            f"тЬЕ **рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕реНрдЯреЛрд░ рд╣реЛ рдЧрдИ!**\n\n"
            f"рдпрд╣ рдЖрдкрдХреА Deep Link рд╣реИ (рд╕рд░реНрд╡рд░ рд░реАрд╕реНрдЯрд╛рд░реНрдЯ рд╣реЛрдиреЗ рдкрд░ рднреА рдХрд╛рдо рдХрд░реЗрдЧреА):\n\n"
            f"`{deep_link}`\n\n"
            f"**рдЯреЗрд╕реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:** рдЗрд╕реЗ рдХрд┐рд╕реА рдФрд░ рдпреВрдЬрд╝рд░ рдХреЛ рднреЗрдЬреЗрдВ рдпрд╛ рдЦреБрдж 'Start' рдХрд░реЗрдВред"
        )
        
    except Exception as e:
        print(f"Admin file handling error: {e}")
        await message.reply_text(f"рдлрд╝рд╛рдЗрд▓ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░рддреЗ рд╕рдордп рдПрдХ рддреНрд░реБрдЯрд┐ рд╣реБрдИ: {e}")

# --- 4. Deep Link рд╕реНрдЯрд╛рд░реНрдЯ рд╣реИрдВрдбрд▓рд░ (Deep Link Start Handler) ---
@app.on_message(filters.private & filters.command("start"))
async def handle_start(client: Client, message: Message):
    """
    рдпреВрдЬрд╝рд░ рджреНрд╡рд╛рд░рд╛ '/start' рдХрдорд╛рдВрдб рдХреЛ рд╣реИрдВрдбрд▓ рдХрд░рддрд╛ рд╣реИред
    рдЕрдЧрд░ payload (message_id) рдореМрдЬреВрдж рд╣реИ, рддреЛ рдлрд╝рд╛рдЗрд▓ рднреЗрдЬрддрд╛ рд╣реИред
    """
    # '/start' рдХрдорд╛рдВрдб рдХреЗ рдмрд╛рдж рдХреЗ payload рдХреЛ рдирд┐рдХрд╛рд▓реЗрдВ (рдЙрджрд╛: 12345)
    if len(message.command) > 1:
        payload = message.command[1]
        
        try:
            message_id = int(payload)
            
            # channel рд╕реЗ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдпреВрдЬрд╝рд░ рдХреЛ рдХреЙрдкреА рдХрд░реЗрдВ
            # copy_message рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдпреВрдЬрд╝рд░ рдХреЛ Channel рдХрд╛ рдирд╛рдо рдирд╣реАрдВ рджрд┐рдЦреЗрдЧрд╛
            await client.copy_message(
                chat_id=message.chat.id,  # рд╡рд░реНрддрдорд╛рди рдпреВрдЬрд╝рд░
                from_chat_id=CHANNEL_ID, # рд╕реНрдЯреЛрд░реЗрдЬ рдЪреИрдирд▓
                message_id=message_id    # deep link рд╕реЗ рдорд┐рд▓рд╛ message_id
            )
            
            await message.reply_text(
                "тЬЕ **рдЖрдкрдХреА рд░рд┐рдХреНрд╡реЗрд╕реНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓ рд╣рд╛рдЬрд╝рд┐рд░ рд╣реИ!**\n\n"
                "рдЕрдЧрд░ рдлрд╝рд╛рдЗрд▓ рди рджрд┐рдЦреЗ, рддреЛ рд╢рд╛рдпрдж рдпрд╣ рдПрдХ рдмрд╣реБрдд рдмрдбрд╝реА рдлрд╝рд╛рдЗрд▓ рд╣реИ рдФрд░ Telegram рдЗрд╕реЗ Process рдХрд░ рд░рд╣рд╛ рд╣реИред"
            )
            
        except ValueError:
            # рдЕрдЧрд░ payload рдирдВрдмрд░ рдирд╣реАрдВ рд╣реИ
            await message.reply_text("рдирдорд╕реНрддреЗ! рдЕрдорд╛рдиреНрдп Deep Link IDред")
            
        except Exception as e:
            # рдЕрдЧрд░ message_id рдЪреИрдирд▓ рдореЗрдВ рди рдорд┐рд▓реЗ рдпрд╛ рдХреЛрдИ рдФрд░ error рд╣реЛ
            print(f"Error fetching file: {e}")
            await message.reply_text(
                "тЭМ **рдХреНрд╖рдорд╛ рдХрд░реЗрдВ!** рдпрд╣ рдлрд╝рд╛рдЗрд▓ рдЕрдм рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИ рдпрд╛ рд▓рд┐рдВрдХ рдПрдХреНрд╕рдкрд╛рдпрд░ рд╣реЛ рдЧрдпрд╛ рд╣реИред"
            )
            
    else:
        # рдЕрдЧрд░ рдХреЛрдИ payload рдирд╣реАрдВ рд╣реИ (рдпреВрдЬрд╝рд░ рдиреЗ рдмрд╕ /start рдХрд┐рдпрд╛ рд╣реИ)
        is_admin = message.from_user.id == ADMIN_ID
        
        welcome_text = (
            "ЁЯСЛ **рдирдорд╕реНрддреЗ! рдореИрдВ Deep Link Bot рд╣реВрдБред**\n\n"
            "рдореИрдВ рдЖрдкрдХреЛ рдлрд╛рдЗрд▓ рдХреА Deep Link рдмрдирд╛рдХрд░ рджреЗрддрд╛ рд╣реВрдБ, рдЬреЛ рд╕рд░реНрд╡рд░ рд░реАрд╕реНрдЯрд╛рд░реНрдЯ рдХреЗ рдмрд╛рдж рднреА рдХрд╛рдо рдХрд░рддреА рд╣реИред\n\n"
            "**рдпреВрдЬрд╝рд░ рдЧрд╛рдЗрдб:**\n"
            "1. рдЖрдкрдХреЛ рдмрд╕ Deep Link рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдирд╛ рд╣реИ рдФрд░ рдлрд╝рд╛рдЗрд▓ рдорд┐рд▓ рдЬрд╛рдПрдЧреАред\n\n"
        )
        
        if is_admin:
            welcome_text += (
                "**ЁЯСС рдПрдбрдорд┐рди рдореЛрдб рд╕рдХреНрд░рд┐рдп:**\n"
                "рдлрд╝рд╛рдЗрд▓ рдХрд╛ рд▓рд┐рдВрдХ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдмрд╕ **рдореБрдЭреЗ** (рдПрдбрдорд┐рди рдХреЛ) рдХреЛрдИ рднреА рдлрд╝рд╛рдЗрд▓ рднреЗрдЬреЗрдВ (рдбреЙрдХреНрдпреВрдореЗрдВрдЯ, рд╡реАрдбрд┐рдпреЛ, рдЖрджрд┐)ред "
                "рдореИрдВ рдЖрдкрдХреЛ рддреБрд░рдВрдд Deep Link рд╡рд╛рдкрд╕ рднреЗрдЬ рджреВрдБрдЧрд╛ред"
            )
        
        await message.reply_text(welcome_text)


# --- 5. Flask Keep-Alive рд╕рд░реНрд╡рд░ (Flask Keep-Alive Server for Replit) ---
# Replit рдХреЛ рдпрд╣ рдмрддрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдмреЙрдЯ рдЪрд╛рд▓реВ рд╣реИ рдФрд░ рдЗрд╕реЗ рдмрдВрдж рди рдХрд░реЗрдВред
flask_app = Flask(__name__)

@flask_app.route('/')
def home():
    """рдПрдХ рд╕рд╛рдзрд╛рд░рдг рд░реВрдЯ рддрд╛рдХрд┐ Replit рдХреЛ 200 OK Response рдорд┐рд▓ рд╕рдХреЗред"""
    return jsonify({"status": "Bot is running", "platform": "Replit"}), 200

def run_flask():
    """Flask рдХреЛ рдПрдХ рдЕрд▓рдЧ рдереНрд░реЗрдб рдореЗрдВ рдЪрд▓рд╛рддрд╛ рд╣реИред"""
    port = int(os.environ.get('PORT', 8080))
    # '0.0.0.0' рдкрд░ рдЪрд▓рд╛рдПрдВ рддрд╛рдХрд┐ Replit рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░ рд╕рдХреЗ
    flask_app.run(host='0.0.0.0', port=port)

# --- 6. рдореБрдЦреНрдп рдлрд╝рдВрдХреНрд╢рди рдЬреЛ рдмреЙрдЯ рдФрд░ рд╕рд░реНрд╡рд░ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ (Main function to start bot and server) ---
if __name__ == "__main__":
    print("Starting Flask Keep-Alive server...")
    # Flask рд╕рд░реНрд╡рд░ рдХреЛ рдПрдХ рдирдП рдереНрд░реЗрдб рдореЗрдВ рд╢реБрд░реВ рдХрд░реЗрдВ
    Thread(target=run_flask).start()
    
    print("Starting Telegram Bot...")
    # Pyrogram рдмреЙрдЯ рдХреЛ рд╢реБрд░реВ рдХрд░реЗрдВ (рдпрд╣ рдореБрдЦреНрдп рдереНрд░реЗрдб рдореЗрдВ рдЪрд▓рддрд╛ рд░рд╣реЗрдЧрд╛)
    app.run()
    
    # рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдмреЙрдЯ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдмрдВрдж рд╣реЛ
    print("Bot stopped.")
        
